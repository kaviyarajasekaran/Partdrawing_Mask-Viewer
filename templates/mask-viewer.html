<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ALFA TKG ‚Äî Interactive Mask Viewer</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, #0a3d62 0%, #102f45 30%, #f5f7fb 100%);
      color: #333;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    header {
      background: #0a3d62;
      color: #fff;
      padding: 30px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    header img {
      height: 100px;
      margin-bottom: 10px;
      border-radius: 10px;
    }

    header h1 {
      font-size: 30px;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 5px 0;
    }
    /* ===== NAVIGATION BUTTONS (Prev / Next) ===== */
#prevBtn, #nextBtn {
  display: inline-block;
  background: linear-gradient(135deg, #0a3d62, #1e5a8b);
  color: #fff;
  border: none;
  padding: 14px 35px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  letter-spacing: 0.5px;
  margin: 25px 10px 0 10px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

#prevBtn:hover, #nextBtn:hover {
  background: linear-gradient(135deg, #0e4c7f, #0a3d62);
  transform: scale(1.05);
}

#prevBtn::before {
  content: "‚Üê ";
  font-weight: bold;
}

#nextBtn::after {
  content: " ‚Üí";
  font-weight: bold;
}

    /* ===== CONTAINERS ===== */
    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 30px;
      background: #ffffffee;
      border-radius: 20px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.15);
      text-align: center;
    }

    h2 {
      font-size: 26px;
      color: #e6e8e9;
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
      margin: 10px 0 25px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 20px;
      color: #0a3d62;
    }

    /* ===== INPUTS ===== */
    input[type=file] {
      margin: 12px auto 25px;
      font-size: 15px;
      background: #eef2f7;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    /* ===== BUTTON ===== */
    .btn {
      background: linear-gradient(135deg, #0a3d62, #1e5a8b);
      color: #fff;
      border: none;
      padding: 14px 35px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.5px;
      transition: transform 0.2s, background 0.3s;
    }

    .btn:hover {
      background: linear-gradient(135deg, #0e4c7f, #0a3d62);
      transform: scale(1.04);
    }

    .btn:disabled {
      background: #999;
      cursor: not-allowed;
    }

    #error {
      color: #d00;
      margin-top: 15px;
      font-weight: 600;
    }

    /* ===== VIEWER ===== */
    #viewer {
      display: none;
      margin-top: 30px;
    }

    .viewer {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 30px;
      flex-wrap: wrap;
      margin-top: 25px;
    }

    canvas {
      display: block;
      border-radius: 12px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.15);
      max-width: 100%;
      height: auto;
    }

    #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .canvas-wrapper {
      position: relative;
      display: inline-block;
    }

    footer {
      text-align: center;
      font-size: 14px;
      color: #eee;
      margin-top: 40px;
      padding: 20px;
      background: #0a3d62;
      border-top: 2px solid #084066;
    }

    /* ===== UPLOAD ROW ===== */
    .upload-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .upload-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .upload-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #0a3d62;
    }

    .upload-group input[type=file] {
      background: #eef2f7;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 260px;
      height: 44px;
      font-size: 14px;
    }

    .upload-row .btn {
      align-self: center;
      height: 44px;
      margin-top: 22px;
      padding: 0 30px;
    }

    #nextBtn {
      margin-top: 25px;
      display: none;
    }
    /* ===== FLOATING TOOL BUTTONS (Right Side) ===== */
/* floating Tools: vertical pills with icon on top, label below */
.floating-tools {
  position: fixed;
  top: 65%;
  right: 24px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  z-index: 1000;
  transform: translateY(-50%);
}

.tool-btn.active {
  background-color: #d9534f;
  color: #fff;
}


.tool-btn {
  width: 64px;
  height: 64px;
  background: #fff;
  color: #0a3d62;
  border: 2px solid rgba(10,61,98,0.06);
  padding: 6px;
  border-radius: 14px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
  transition: all 0.18s ease;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  text-align:center;
}

.tool-btn div { line-height:1; }

.tool-btn:hover {
  background: #0a3d62;
  color: #fff;
  transform: translateX(-4px);
}

/* hide the tools until the viewer is scrolled into view (optional: small fade-in) */
#editTools[style*="display:none"] { opacity: 0; pointer-events: none; }
#editTools[style*="display:flex"] { opacity: 1; transition: opacity 220ms ease-in; pointer-events: auto; }


.tool-btn:hover {
  background: #0a3d62;
  color: #fff;
  transform: scale(1.05);
}
#tools {
  position: absolute;
  top: 15px;
  left: 15px;
  display: flex;
  gap: 8px;
  z-index: 100;
}

.zoom-controls {
  position: fixed;
  top: 45%;
  left: 24px;
  transform: translateY(-50%);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  background: rgba(255, 255, 255, 0.9);
  padding: 10px;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}
.zoom-controls button {
  border: none;
  background: #0a3d62;
  color: #fff;
  font-size: 18px;
  border-radius: 10px;
  padding: 8px 10px;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.2s ease;
}
.zoom-controls button:hover {
  background: #164d7a;
  transform: scale(1.05);
}
#zoomLevel {
  font-weight: 700;
  color: #0a3d62;
  font-size: 14px;
}
.back-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color: #444;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-weight: bold;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.back-btn:hover {
  background-color: #222;
  cursor: pointer;
}
/* Navigation buttons (Next / Previous) */
/* === Viewer Page Layout === */
body.viewer-active {
  margin: 0;
  height: 100vh;
  overflow: hidden;
  background: linear-gradient(to bottom, #0b3d6b, #6e8ea5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

/* Hide the top header when viewing image */
body.viewer-active header,
body.viewer-active .logo,
body.viewer-active h1 {
  display: none !important;
}

/* Center image and controls vertically */
/* Next/Previous buttons */
#navButtons {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-top: 10px;
}

#navButtons button {
  background-color: #0b3d6b;
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

#navButtons button:hover {
  background-color: #155a9c;
}

/* Fixed back button at bottom-left corner */
.back-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color: #0b3d6b;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

  </style>
</head>
<body>
  <header>
    <img src="static\images\com logo.jpg" alt="ALFA TKG Logo">
    <h1>Partdrawing Mask Viewer</h1>
  </header>

  <div class="container" id="uploadSection">
    <h2>Upload ZIP Files</h2>
    <p>Upload one ZIP of noisy images and one ZIP of corresponding mask (.npy) files.</p>

    <form id="uploadForm" method="POST" enctype="multipart/form-data">
      <div class="upload-row">
        <div class="upload-group">
          <label for="noisy_zip">Noisy Images ZIP</label>
          <input type="file" id="noisy_zip" name="noisy_zip" accept=".zip" required>
        </div>
        <div class="upload-group">
          <label for="mask_zip">Mask Files ZIP</label>
          <input type="file" id="mask_zip" name="mask_zip" accept=".zip" required>
        </div>
        <button type="submit" class="btn" id="uploadBtn">Upload & Preview</button>
      </div>
    </form>
    <p id="error"></p>
  </div>

  <div id="viewer">
    <h2>Image Preview</h2>
    <button id="backBtn" class="btn back-btn">‚¨Ö Back to Upload</button>
    <div class="viewer">
      <div class="canvas-wrapper">
        <canvas id="baseCanvas"></canvas>
        <canvas id="overlayCanvas"></canvas>
      </div>
    </div>
    <p>Active Mask: <span id="maskLabel">None</span></p>
    <div id="navButtons" class="nav-btns" style="display:none;">
      <button id="prevBtn"> Previous</button>
      <button id="nextBtn">Next </button>
    </div>
  </div>
  <div id="editTools" class="floating-tools" style="display:none;">
  <button id="undo-btn" class="tool-btn" title="Undo Last Action">
    <div style="font-size:18px;line-height:1">‚Ü©</div>
    <div style="font-size:13px;margin-top:6px">Undo</div>
  </button>

  <button id="save-btn" class="tool-btn" title="Save">
    <div style="font-size:18px;line-height:1">üíæ</div>
    <div style="font-size:13px;margin-top:6px">Save</div>
  </button>

  <button id="saveas-btn" class="tool-btn" title="Save As">
    <div style="font-size:18px;line-height:1">üìÅ</div>
    <div style="font-size:13px;margin-top:6px">Save As</div>
  </button>

  <button id="remove-btn" class="tool-btn" title="Remove Mask">
    <div style="font-size:18px;line-height:1">ü©∏</div>
    <div style="font-size:13px;margin-top:6px">Remove</div>
  </button>

  <button id="redo-btn" class="tool-btn" title="Redo Action">
    <div style="font-size:18px;line-height:1">‚Ü™</div>
    <div style="font-size:13px;margin-top:6px">Redo</div>
  </button>
  <button id="eraserBtn" class="tool-btn">üßΩ Erase Mode</button>
  <label id="eraserSizeLabel" for="eraserSize" style="color:white;margin-left:10px;">Eraser_Size:</label>
  <input type="range" id="eraserSize" min="5" max="60" value="20" style="width:120px;">
</div>
<div id="zoomControls" class="zoom-controls" style="display:none;">
  <button id="zoomInBtn" title="Zoom In">Ôºã</button>
  <span id="zoomLevel">100%</span>
  <button id="zoomOutBtn" title="Zoom Out">Ôºç</button>
</div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
  const storedPairs = localStorage.getItem("uploadedPairs");
  if (storedPairs) {
    imagesData = JSON.parse(storedPairs);
    currentIndex = 0;
    document.getElementById("uploadSection").style.display = "none";
    document.getElementById("viewer").style.display = "block";
    document.getElementById("editTools").style.display = "flex";
    document.getElementById("zoomControls").style.display = "flex";
    showImage(currentIndex);
    const multiple = imagesData.length > 1;
    nextBtn.style.display = multiple ? "inline-block" : "none";
    prevBtn.style.display = multiple ? "inline-block" : "none";
    viewer.scrollIntoView({ behavior: 'smooth' });
    document.getElementById("editTools").style.display = "flex";
    document.getElementById("navButtons").style.display = "flex";
  }
});

  const form = document.getElementById('uploadForm');
  const errorBox = document.getElementById('error');
  const viewer = document.getElementById('viewer');
  const baseCanvas = document.getElementById('baseCanvas');
  const overlayCanvas = document.getElementById('overlayCanvas');
  const maskLabel = document.getElementById('maskLabel');
  const uploadBtn = document.getElementById('uploadBtn');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const removeBtn = document.getElementById('remove-btn');
  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');

  let selectedLabel = -1;
  let undoStack = [];
  let redoStack = [];

  let imagesData = [];
  let currentIndex = 0;
  let labelData = null, W, H, overlayCtx;

  // Show errors safely
  function showError(msg) {
    errorBox.textContent = msg;
    console.error("‚ùå Error:", msg);
  }
  function clearError() {
    errorBox.textContent = '';
  }

  // === Handle Form Submit ===
form.onsubmit = async (e) => {
  e.preventDefault();
  clearError();

  const noisyZip = document.getElementById('noisy_zip').files[0];
  const maskZip = document.getElementById('mask_zip').files[0];

  if (!noisyZip || !maskZip) {
    showError("Please upload both ZIP files.");
    return;
  }

  const fd = new FormData();
  fd.append("noisy_zip", noisyZip);
  fd.append("mask_zip", maskZip);

  uploadBtn.disabled = true;
  uploadBtn.textContent = "Processing...";

  try {
    const res = await fetch("/upload", { method: "POST", body: fd });
    const text = await res.text();
    let data;

    try {
      data = JSON.parse(text);
    } catch {
      throw new Error("Server returned invalid JSON:\n" + text.slice(0, 150));
    }

    if (!res.ok || data.error) {
      throw new Error(data.error || "Upload failed on server.");
    }

    // ‚úÖ Save image/mask pairs for next page
    const pairs = Array.isArray(data) ? data : data.pairs || [];
    if (pairs.length === 0) throw new Error("No valid image/mask pairs found.");

    localStorage.setItem("uploadedPairs", JSON.stringify(pairs));

    // ‚úÖ Go to viewer page
    window.location.href = "/viewer";

  } catch (err) {
    showError(err.message);
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = "Upload & Preview";
  }
};

  // === Next Button ===
nextBtn.onclick = async () => {
  if (imagesData.length === 0) return;
  currentIndex = (currentIndex + 1) % imagesData.length;
  await showImage(currentIndex);
};

  // === Previous Button ===
prevBtn.onclick = async () => {
  if (imagesData.length === 0) return;
  currentIndex = (currentIndex - 1 + imagesData.length) % imagesData.length;
  await showImage(currentIndex);
};

  // === Show Image + Mask ===
  async function showImage(index) {
    const data = imagesData[index];
    if (!data.noisy_url || !data.label_url) {
      showError("Missing image or mask URL for index " + index);
      return;
    }

    W = data.width || 512;
    H = data.height || 512;
    viewer.style.display = 'block';

    await drawImage(baseCanvas, data.noisy_url, W, H);
    await parseLabelImage(data.label_url);
  }

  function drawImage(canvas, url, W, H) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        canvas.width = W;
        canvas.height = H;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, W, H);
        overlayCanvas.width = W;
        overlayCanvas.height = H;
        overlayCtx = overlayCanvas.getContext('2d');
        resolve();
      };
      img.onerror = () => reject(new Error("Failed to load image: " + url));
      img.src = url + "?v=" + Date.now();
    });
  }

  function parseLabelImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const tmp = document.createElement('canvas');
        tmp.width = W;
        tmp.height = H;
        const ctx = tmp.getContext('2d');
        ctx.drawImage(img, 0, 0, W, H);
        const pixels = ctx.getImageData(0, 0, W, H).data;
        labelData = new Uint16Array(W * H);
        for (let i = 0, j = 0; j < labelData.length; j++, i += 4)
          labelData[j] = pixels[i];
        setupHover();
        resolve();
      };
      img.onerror = () => reject(new Error("Failed to load mask: " + url));
      img.src = url + "?v=" + Date.now();
    });
  }
  // Create consistent distinct colors per label ID
function getColorForLabel(label) {
  const r = (label * 37) % 255;
  const g = (label * 91) % 255;
  const b = (label * 53) % 255;
  return [r, g, b];
}

  function highlightMask(label) {
  const [r, g, b] = getColorForLabel(label);
  const imgData = overlayCtx.createImageData(W, H);
  for (let i = 0; i < labelData.length; i++) {
    if (labelData[i] === label) {
      const k = i * 4;
      imgData.data[k] = r;
      imgData.data[k + 1] = g;
      imgData.data[k + 2] = b;
      imgData.data[k + 3] = 80; // translucent overlay
    }
  }
  overlayCtx.putImageData(imgData, 0, 0);
}


// Remember hovered mask ID
function setupHover() {
  let currentHover = -1;

  baseCanvas.onmousemove = (e) => {
    const rect = baseCanvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (W / rect.width));
    const y = Math.floor((e.clientY - rect.top) * (H / rect.height));
    const label = labelData[y * W + x];
    if (label !== currentHover) {
      currentHover = label;
      overlayCtx.clearRect(0, 0, W, H);
      if (label > 0) highlightMask(label);
    }
  };

  // üü¢ Click to SELECT mask permanently
  baseCanvas.onclick = (e) => {
    const rect = baseCanvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (W / rect.width));
    const y = Math.floor((e.clientY - rect.top) * (H / rect.height));
    const label = labelData[y * W + x];
    if (label > 0) {
      selectedLabel = label;
      maskLabel.textContent = 'Selected Mask: ' + label;
      overlayCtx.clearRect(0, 0, W, H);
      highlightMask(label); // keep it colored after click
    }
  };

  baseCanvas.onmouseleave = () => {
    overlayCtx.clearRect(0, 0, W, H);
  };
}

removeBtn.onclick = () => {
  if (selectedLabel <= 0) {
    alert("Please hover and select a mask area first.");
    return;
  }

  // Save current state
  const ctx = baseCanvas.getContext('2d');
  undoStack.push(ctx.getImageData(0, 0, W, H));
  redoStack = [];

  // Paint selected region white
  const imgData = ctx.getImageData(0, 0, W, H);
  for (let i = 0; i < labelData.length; i++) {
    if (labelData[i] === selectedLabel) {
      const k = i * 4;
      imgData.data[k] = 255;
      imgData.data[k + 1] = 255;
      imgData.data[k + 2] = 255;
      imgData.data[k + 3] = 255;
    }
  }
  ctx.putImageData(imgData, 0, 0);
  overlayCtx.clearRect(0, 0, W, H);
  maskLabel.textContent = `Removed Mask: ${selectedLabel}`;
};

// --- Save / Save As improvements ----------------------------------------------
const saveBtn = document.getElementById('save-btn');
const saveAsBtn = document.getElementById('saveas-btn');

function defaultFilenameForIndex(idx) {
  try {
    const url = imagesData[idx].noisy_url || imagesData[idx].image || '';
    const parts = url.split('/');
    let name = parts[parts.length - 1] || `image_${idx}.png`;
    name = name.split('?')[0];
    if (!name.toLowerCase().endsWith('.png')) name = name.replace(/\.\w+$/, '') + '.png';
    return name;
  } catch {
    return `image_${idx}.png`;
  }
}

// Send image (dataURL) to server. Optionally ask server to replace original path.
async function postSaveImageToServer(dataURL, filename, replacePath = null) {
  const fd = new FormData();
  fd.append('image_data', dataURL);
  fd.append('filename', filename);
  if (replacePath) fd.append('replace_path', replacePath);

  const resp = await fetch('/save_cleaned_image', { method: 'POST', body: fd });
  return resp.json();
}

saveBtn.onclick = async () => {
  if (!imagesData || imagesData.length === 0) { alert('No image to save'); return; }
  try {
    saveBtn.disabled = true;
    const dataURL = baseCanvas.toDataURL('image/png');
    const filename = defaultFilenameForIndex(currentIndex);
    let replacePath = null;
    const noisy = imagesData[currentIndex].noisy_url || imagesData[currentIndex].image || '';
    if (noisy.includes('/static/')) {
      replacePath = noisy.split('/static/')[1].split('?')[0]; // remove query strin
      }

    const res = await postSaveImageToServer(dataURL, filename, replacePath);
    console.log("Saving image to:", replacePath);

    if (res && res.success) {
      if (res.saved_path) {
        imagesData[currentIndex].noisy_url = (res.saved_url || ('/static/' + res.saved_path));
      } else if (replacePath) {
        imagesData[currentIndex].noisy_url = '/static/' + replacePath;
      } else {
        imagesData[currentIndex].noisy_url = '/static/cleaned/' + filename;
      }
      alert('Saved: ' + (res.filename || filename));
    } else {
      alert('Save failed: ' + (res && res.error ? res.error : 'unknown'));
    }
  } catch (err) {
    alert('Save error: ' + err.message);
  } finally {
    saveBtn.disabled = false;
  }
};

// Save As -> prompt OS save dialog by creating a Blob and anchor (download)
saveAsBtn.onclick = async () => {
  const zipName = prompt("Enter ZIP name:", "cleaned_images");
  if (!zipName) return;

  try {
    const res = await fetch("/saveas_cleaned_zip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ zip_name: zipName })
    });
    const data = await res.json();
    if (data.success) {
      const link = document.createElement("a");
      link.href = data.download_url;
      link.download = zipName.endsWith(".zip") ? zipName : `${zipName}.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert("Save As failed: " + (data.error || "unknown error"));
    }
  } catch (err) {
    alert("Save As error: " + err.message);
  }
};

undoBtn.onclick = () => {
  const ctx = baseCanvas.getContext('2d');
  if (undoStack.length === 0) return;
  redoStack.push(ctx.getImageData(0, 0, W, H));
  ctx.putImageData(undoStack.pop(), 0, 0);
};

redoBtn.onclick = () => {
  const ctx = baseCanvas.getContext('2d');
  if (redoStack.length === 0) return;
  undoStack.push(ctx.getImageData(0, 0, W, H));
  ctx.putImageData(redoStack.pop(), 0, 0);
};
// === Eraser Tool ===
const overlay = document.getElementById('overlayCanvas');
const ctxOverlay = overlay.getContext('2d');
const eraserBtn = document.getElementById('eraserBtn');
const eraserSizeSlider = document.getElementById('eraserSize');

let eraserActive = false;
let eraserSize = parseInt(eraserSizeSlider.value);
let isErasing = false;

// === TOGGLE ERASER MODE ===
eraserBtn.addEventListener('click', () => {
  eraserActive = !eraserActive;
  eraserBtn.classList.toggle('active', eraserActive);
  eraserBtn.textContent = eraserActive ? "üßΩ Erase: ON" : "üßΩ Erase Mode";

  // When eraser is active ‚Üí hide mask overlay
  if (eraserActive) {
    overlay.style.pointerEvents = "auto";
    if (typeof selectedLabel !== "undefined") selectedLabel = -1;
    overlayCtx.clearRect(0, 0, W, H);
  } else {
    overlay.style.pointerEvents = "none";
  }
});

// === SLIDER CONTROL ===
eraserSizeSlider.addEventListener('input', e => {
  eraserSize = parseInt(e.target.value);
});

// === ERASING BEHAVIOR ===
overlay.addEventListener('mousedown', e => {
  if (!eraserActive) return;
  // Save state before starting erase
  const ctx = baseCanvas.getContext('2d');
  undoStack.push(ctx.getImageData(0, 0, W, H));
  redoStack = [];

  isErasing = true;
  eraseAt(e.offsetX, e.offsetY);
});

overlay.addEventListener('mousemove', e => {
  if (!isErasing || !eraserActive) return;
  eraseAt(e.offsetX, e.offsetY);
});

overlay.addEventListener('mouseup', () => isErasing = false);
overlay.addEventListener('mouseleave', () => isErasing = false);

// === ERASE FUNCTION (paint white on baseCanvas) ===
function eraseAt(x, y) {
  const ctx = baseCanvas.getContext('2d');
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(x, y, eraserSize / 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();
}
// === ZOOM FEATURE ===
const zoomInBtn = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');
const zoomLevelLabel = document.getElementById('zoomLevel');

let zoom = 1;
const ZOOM_STEP = 0.1;
const ZOOM_MIN = 0.2;
const ZOOM_MAX = 5;

// Helper: Apply zoom scaling
function applyZoom() {
  const canvases = [baseCanvas, overlayCanvas];
  canvases.forEach(c => {
    c.style.transformOrigin = "center center";
    c.style.transform = `scale(${zoom})`;
  });
  zoomLevelLabel.textContent = Math.round(zoom * 100) + "%";
}

// Zoom in/out via buttons
zoomInBtn.addEventListener('click', () => {
  zoom = Math.min(zoom + ZOOM_STEP, ZOOM_MAX);
  applyZoom();
});

zoomOutBtn.addEventListener('click', () => {
  zoom = Math.max(zoom - ZOOM_STEP, ZOOM_MIN);
  applyZoom();
});

// === Mouse wheel zoom ===
viewer.addEventListener('wheel', e => {
  e.preventDefault();
  if (e.deltaY < 0) {
    zoom = Math.min(zoom + ZOOM_STEP, ZOOM_MAX); // scroll up ‚Üí zoom in
  } else {
    zoom = Math.max(zoom - ZOOM_STEP, ZOOM_MIN); // scroll down ‚Üí zoom out
  }
  applyZoom();
}, { passive: false });

// === BACK TO UPLOAD PAGE ===
document.getElementById("backBtn").addEventListener("click", () => {
  document.getElementById("viewer").style.display = "none";
  document.getElementById("uploadSection").style.display = "block";
  document.getElementById("editTools").style.display = "none";
  document.getElementById("zoomControls").style.display = "none";
  window.scrollTo({ top: 0, behavior: "smooth" });
});
// === Viewer Mode Controls ===
function activateViewerMode() {
  document.body.classList.add("viewer-active");
}

function deactivateViewerMode() {
  document.body.classList.remove("viewer-active");
  window.location.href = "/"; // or "/upload" if you have that route
}
// When the viewer page loads, activate viewer mode automatically:
if (window.location.pathname.includes("/viewer")) {
  activateViewerMode();
}


</script>
</body>
</html>